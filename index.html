<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>999 Oxford Radio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
:root {
  --bg: #0b1220;
  --panel: #121a2b;
  --elev: #18243b;
  --text: #e6edf7;
  --muted: #9fb1d1;
  --accent: #4ea1ff;
  --accent-2: #7bd389;
  --danger: #ff5c5c;
  --tab: #22324f;
  --border: #243555;
}

* { box-sizing: border-box; }
html, body { height: 100%; }
body {
  margin: 0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
  color: var(--text);
  background: radial-gradient(1200px 800px at 10% -20%, #16223a 0%, var(--bg) 60%);
}

.app-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  background: linear-gradient(180deg, #0e1626 0%, #0b1220 100%);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 5;
}
.brand { font-weight: 700; letter-spacing: 0.3px; }
.user-info { display: flex; gap: 10px; align-items: center; color: var(--muted); }
.callsign { font-weight: 700; color: var(--text); background: #1b2a47; padding: 2px 8px; border-radius: 6px; }
.link-button { background: none; border: none; color: var(--accent); cursor: pointer; padding: 6px 8px; border-radius: 6px; }
.link-button:hover { background: #13223e; }

.app-main { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; padding: 14px; height: calc(100% - 58px); }

.radio-panel, .side-panel, .quick-messages, .placeholder {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.02);
}

.radio-panel { display: flex; flex-direction: column; min-height: 0; }
.channel-tabs { display: flex; gap: 6px; padding: 10px; border-bottom: 1px solid var(--border); background: #0f1a30; border-top-left-radius: 12px; border-top-right-radius: 12px; }
.tab { background: var(--tab); border: 1px solid var(--border); color: var(--text); padding: 8px 10px; border-radius: 8px; cursor: pointer; }
.tab:hover { background: #2b416d; }
.tab.active { background: linear-gradient(180deg, #2b416d 0%, #23365b 100%); border-color: #3a5891; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06); }

.radio-feed { flex: 1; overflow: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
.radio-line { background: var(--elev); border: 1px solid var(--border); padding: 8px 10px; border-radius: 8px; line-height: 1.3; }

.side-panel { display: flex; flex-direction: column; gap: 14px; min-height: 0; }
.quick-messages, .placeholder { flex: 1; display: flex; flex-direction: column; }
.quick-messages h2, .placeholder h2 { margin: 12px; font-size: 16px; color: var(--muted); }
.quick-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; padding: 0 12px 12px; }
.quick-btn { padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #1a2847; color: var(--text); cursor: pointer; text-align: left; }
.quick-btn:hover { filter: brightness(1.15); }
.quick-btn.primary { background: #1e335d; border-color: #2b4c86; }
.quick-btn.success { background: #1b3a2e; border-color: #275845; }
.quick-btn.warning { background: #4a3a1f; border-color: #6a532e; }
.quick-btn.danger { background: #4a1f1f; border-color: #6a2e2e; }

.placeholder-body { margin: 0 12px 12px; flex: 1; border: 2px dashed #2a3d66; border-radius: 10px; display: grid; place-items: center; color: var(--muted); }

/* Modal */
.modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; padding: 16px; }
.modal-backdrop[aria-hidden="false"] { display: flex; }
.modal { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; width: 100%; max-width: 420px; padding: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
.modal form { display: grid; gap: 10px; }
label { font-size: 14px; color: var(--muted); }
input, select { background: #0f1a30; border: 1px solid var(--border); color: var(--text); padding: 10px 12px; border-radius: 8px; }
.form-actions { display: flex; justify-content: flex-end; margin-top: 4px; }
button.primary { background: var(--accent); border: none; color: #00122b; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; }
button.primary:hover { filter: brightness(1.05); }
.form-hint { margin: 0; font-size: 12px; color: var(--muted); }

/* Responsive */
@media (max-width: 980px) {
  .app-main { grid-template-columns: 1fr; height: auto; }
  .side-panel { min-height: 50vh; }
}
  </style>
</head>
<body>
  <header class="app-header">
    <div class="brand">999 Oxford Radio</div>
    <div class="user-info">
      <span id="userService"></span>
      <span id="userCallsign" class="callsign"></span>
      <button id="changeIdentityBtn" class="link-button" title="Change service or callsign">Change</button>
    </div>
  </header>

  <main class="app-main">
    <section class="radio-panel">
      <div class="channel-tabs" role="tablist" aria-label="Channels">
        <button class="tab active" role="tab" aria-selected="true" data-channel="Global">Global</button>
        <button class="tab" role="tab" aria-selected="false" data-channel="Thames Valley Police">Thames Valley Police</button>
        <button class="tab" role="tab" aria-selected="false" data-channel="South Central Ambulance Service">South Central Ambulance Service</button>
      </div>
      <div class="radio-feed" id="radioFeed" aria-live="polite"></div>
    </section>

    <section class="side-panel">
      <div class="quick-messages">
        <h2>Quick messages</h2>
        <div class="quick-grid" id="quickGrid"></div>
      </div>
      <div class="placeholder">
        <h2>Placeholder</h2>
        <div class="placeholder-body">This area is reserved for future features.</div>
      </div>
    </section>
  </main>

  <div class="modal-backdrop" id="loginModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="loginTitle" aria-modal="true">
      <h2 id="loginTitle">Identify yourself</h2>
      <form id="loginForm" novalidate>
        <label for="serviceSelect">Service</label>
        <select id="serviceSelect" required>
          <option value="">Select service</option>
          <option value="Thames Valley Police">Thames Valley Police (TVP)</option>
          <option value="South Central Ambulance Service">South Central Ambulance Service (SCAS)</option>
        </select>

        <label for="callsignInput">Callsign (4 digits)</label>
        <input id="callsignInput" type="text" inputmode="numeric" pattern="\\d{4}" maxlength="4" placeholder="e.g. 1234" required />

        <div class="form-actions">
          <button type="submit" class="primary">Continue</button>
        </div>
        <p class="form-hint">Your service and callsign are stored only in this browser.</p>
      </form>
    </div>
  </div>

  <script>
(() => {
  const CHANNELS = [
    "Global",
    "Thames Valley Police",
    "South Central Ambulance Service",
  ];

  const QUICK_MESSAGES = [
    { key: "0", text: "State 0 - Panic, emergency assistance.", cls: "danger" },
    { key: "1", text: "State 1 - On duty.", cls: "primary" },
    { key: "2", text: "State 2 - On patrol.", cls: "primary" },
    { key: "3", text: "State 3 - At station (available).", cls: "success" },
    { key: "4", text: "State 4 - On break.", cls: "warning" },
    { key: "5", text: "State 5 - Enroute.", cls: "primary" },
    { key: "6", text: "State 6 - At scene.", cls: "success" },
    { key: "7", text: "State 7 - Committed, deployable.", cls: "primary" },
    { key: "8", text: "State 8 - Committed, not deployable.", cls: "warning" },
    { key: "9", text: "State 9 - Transporting.", cls: "primary" },
    { key: "11", text: "State 11 - Off duty.", cls: "warning" },
  ];

  const els = {
    userService: document.getElementById("userService"),
    userCallsign: document.getElementById("userCallsign"),
    changeIdentityBtn: document.getElementById("changeIdentityBtn"),
    tabs: Array.from(document.querySelectorAll(".tab")),
    radioFeed: document.getElementById("radioFeed"),
    quickGrid: document.getElementById("quickGrid"),
    loginModal: document.getElementById("loginModal"),
    loginForm: document.getElementById("loginForm"),
    serviceSelect: document.getElementById("serviceSelect"),
    callsignInput: document.getElementById("callsignInput"),
  };

  let selectedChannel = CHANNELS[0];
  let messagesByChannel = loadMessages();
  let user = loadUser();

  function escapeHTML(input) {
    return input
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function loadUser() {
    try {
      const raw = localStorage.getItem("radioUser");
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (!parsed || typeof parsed !== "object") return null;
      const isValidService = parsed.service === "Thames Valley Police" || parsed.service === "South Central Ambulance Service";
      if (!isValidService) return null;
      if (!/^\\d{4}$/.test(String(parsed.callsign || ""))) return null;
      return { service: parsed.service, callsign: String(parsed.callsign) };
    } catch (_e) {
      return null;
    }
  }

  function saveUser(next) {
    localStorage.setItem("radioUser", JSON.stringify(next));
  }

  function loadMessages() {
    try {
      const raw = localStorage.getItem("radioMessagesV1");
      if (!raw) throw new Error("empty");
      const parsed = JSON.parse(raw);
      const base = { Global: [], "Thames Valley Police": [], "South Central Ambulance Service": [] };
      return { ...base, ...parsed };
    } catch (_e) {
      return { Global: [], "Thames Valley Police": [], "South Central Ambulance Service": [] };
    }
  }

  function saveMessages() {
    localStorage.setItem("radioMessagesV1", JSON.stringify(messagesByChannel));
  }

  function showLoginModal(show) {
    els.loginModal.setAttribute("aria-hidden", show ? "false" : "true");
    if (show) {
      requestAnimationFrame(() => {
        els.serviceSelect.focus();
      });
    }
  }

  function updateHeader() {
    if (user) {
      els.userService.textContent = user.service;
      els.userCallsign.textContent = \`[\${user.callsign}]\`;
    } else {
      els.userService.textContent = "";
      els.userCallsign.textContent = "";
    }
  }

  function renderTabs() {
    els.tabs.forEach((tab) => {
      const isActive = tab.dataset.channel === selectedChannel;
      tab.classList.toggle("active", isActive);
      tab.setAttribute("aria-selected", isActive ? "true" : "false");
    });
  }

  function renderFeed() {
    const list = messagesByChannel[selectedChannel] || [];
    els.radioFeed.innerHTML = "";
    for (const msg of list) {
      const div = document.createElement("div");
      div.className = "radio-line";
      div.innerHTML = escapeHTML(msg);
      els.radioFeed.appendChild(div);
    }
    els.radioFeed.scrollTop = els.radioFeed.scrollHeight;
  }

  function sendMessage(rawText) {
    if (!user) {
      showLoginModal(true);
      return;
    }
    const callsign = String(user.callsign).padStart(4, "0");
    const formatted = \`[\${callsign}]: (\${rawText})\`;
    const list = messagesByChannel[selectedChannel] || (messagesByChannel[selectedChannel] = []);
    list.push(formatted);
    if (list.length > 500) list.splice(0, list.length - 500);
    saveMessages();
    renderFeed();
  }

  function handleTabClick(event) {
    const btn = event.currentTarget;
    const ch = btn.dataset.channel;
    if (!CHANNELS.includes(ch)) return;
    selectedChannel = ch;
    renderTabs();
    renderFeed();
  }

  function mountQuickButtons() {
    els.quickGrid.innerHTML = "";
    for (const qm of QUICK_MESSAGES) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = \`quick-btn \${qm.cls || ""}\`;
      btn.textContent = qm.text;
      btn.addEventListener("click", () => sendMessage(qm.text));
      els.quickGrid.appendChild(btn);
    }
  }

  function bindEvents() {
    els.tabs.forEach((tab) => tab.addEventListener("click", handleTabClick));
    els.changeIdentityBtn.addEventListener("click", () => showLoginModal(true));

    els.callsignInput.addEventListener("input", () => {
      els.callsignInput.value = els.callsignInput.value.replace(/[^0-9]/g, "").slice(0, 4);
    });

    els.loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const service = String(els.serviceSelect.value || "");
      const callsign = String(els.callsignInput.value || "");
      const isValidService = service === "Thames Valley Police" || service === "South Central Ambulance Service";
      const isValidCallsign = /^\\d{4}$/.test(callsign);
      if (!isValidService || !isValidCallsign) {
        els.callsignInput.reportValidity();
        return;
      }
      user = { service, callsign };
      saveUser(user);
      updateHeader();
      showLoginModal(false);
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && els.loginModal.getAttribute("aria-hidden") === "false") {
        showLoginModal(false);
      }
    });
  }

  bindEvents();
  mountQuickButtons();
  renderTabs();
  renderFeed();
  if (!user) {
    showLoginModal(true);
  } else {
    updateHeader();
  }
})();
  </script>
  <noscript>This app requires JavaScript enabled.</noscript>
</body>
</html>
